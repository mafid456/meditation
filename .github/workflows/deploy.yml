name: Fullstack App CI/CD

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
      BACKEND_IMAGE: shaikmafidbasha/backend-app
      FRONTEND_IMAGE: shaikmafidbasha/frontend-app

    steps:
      # üß± Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================
      # üõ†Ô∏è Backend (NestJS)
      # =========================
      - name: Build backend
        working-directory: ./backend
        run: |
          echo "Installing backend dependencies..."
          yarn install
          
          echo "Building backend (NestJS)..."
          if yarn run | grep -q "build"; then
            yarn build || npx nest build
          else
            echo "No build script found ‚Äî skipping build step"
          fi

      # =========================
      # üé® Frontend (React / React Native)
      # =========================
      - name: Detect and build frontend
        working-directory: ./frontend
        run: |
          echo "Installing frontend dependencies..."
          yarn install --frozen-lockfile
          
          echo "Detecting frontend type..."
          if grep -q "react-native" package.json; then
            echo "React Native project detected ‚Äî skipping build step."
          else
            echo "React Web project detected ‚Äî running build."
            if yarn run | grep -q "build"; then
              yarn build
            else
              echo "No build script found ‚Äî skipping build step."
            fi
          fi

      # =========================
      # üê≥ Docker Login
      # =========================
      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin

      # =========================
      # üê≥ Build and Push Backend Image
      # =========================
      - name: Build and push backend Docker image
        working-directory: ./backend
        run: |
          echo "Building backend Docker image..."
          docker build -t $BACKEND_IMAGE:latest .
          docker push $BACKEND_IMAGE:latest

      # =========================
      # üê≥ Build and Push Frontend Image
      # =========================
      - name: Build and push frontend Docker image
        working-directory: ./frontend
        run: |
          echo "Building frontend Docker image..."
          docker build -t $FRONTEND_IMAGE:latest .
          docker push $FRONTEND_IMAGE:latest

      # =========================
      # üöÄ OPTIONAL ‚Äî Deploy to EKS
      # =========================
      # - name: Deploy to Kubernetes
      #   env:
      #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #   run: |
      #     aws eks update-kubeconfig --name jenkins-eks-Cluster --region ap-south-1
      #     kubectl apply -f k8s/
